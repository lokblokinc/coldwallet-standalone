<%- layout('layout-minimal') %>

<script type="text/javascript" src="/plug-ins/coldwallet/assets/js/aes.js"></script>
<script src="/plug-ins/coldwallet/assets/js/qrcode.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://cdn.rawgit.com/ricmoo/aes-js/e27b99df/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  /* --- GENERAL STYLES --- */
  body {
    font-family: Roboto, sans-serif;
    background-color: #f4f7f6;
    color: #333;
  }

  .container-panel {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
    position: relative;
    z-index: 1;
  }

  /* BLUE PANEL */
  .cw2-blue-panel {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border-radius: 16px;
    padding: 2.5rem;
    color: white;
    box-shadow: 0 8px 32px rgba(0,123,255,.25);
    margin-bottom: 2rem;
    width: 100%;
  }

  .cw2-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 2rem;
  }

  .cw2-panel-title h1 {
    margin: 0 0 0.5rem 0;
    font-size: 2rem;
    font-weight: 700;
    color: white;
  }

  .cw2-panel-title p {
    margin: 0;
    opacity: 0.9;
    font-size: 1.1rem;
    font-weight: 400;
  }

  .security-badge {
    background: rgba(255,255,255,.15);
    border: 1px solid rgba(255,255,255,.25);
    padding: 8px 16px;
    border-radius: 25px;
    font-size: .9rem;
    color: white;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    backdrop-filter: blur(10px);
  }

  /* INPUTS & SELECTORS STYLE */
  .cw2-address-selector {
    width: 100%;
    padding: 14px 18px;
    border: 2px solid rgba(255,255,255,.25);
    border-radius: 12px;
    background: rgba(255,255,255,.1);
    color: white;
    font-family: 'Courier New', monospace;
    font-size: 1rem;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
  }
  .cw2-address-selector:focus {
    outline: none;
    border-color: rgba(255,255,255,.6);
    background: rgba(255,255,255,.2);
    box-shadow: 0 0 0 4px rgba(255,255,255,.1);
  }
  .cw2-address-selector option {
    background-color: #0056b3;
    color: white;
    padding: 10px;
  }
  .cw2-selector-label {
    display: block;
    margin-bottom: 0.75rem;
    font-weight: 600;
    opacity: 0.95;
    font-size: 1rem;
    color: white;
  }

  /* BUTTONS */
  .btn {
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.2s;
  }
  .btn-light {
    background: white; color: #0056b3; border: none;
  }
  .btn-outline-light {
    background: transparent; color: white; border: 2px solid rgba(255,255,255,0.6);
  }
  .btn-outline-light:hover {
    background: rgba(255,255,255,0.1); border-color: white; color: white;
  }
  
  /* --- MODAL STYLES (FIXED CENTERING) --- */
  /* Ensure custom-modal-content behaves like a real modal panel (some modals use .custom-modal-content, not .modal-content) */
  .custom-modal-content {
    width: 100%;
    border-radius: 14px;
    box-shadow: 0 22px 55px rgba(0,0,0,.28);
    border: 1px solid rgba(0,0,0,.1);
    padding: 0;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    max-height: 90vh;
    overflow: hidden;
    background: #fff;
  }

  /* Make modal header stretch full width (avoid narrow blue header as in QR modal) */
  .cw2-modal-header{
    width: 100%;
    align-self: stretch;
    box-sizing: border-box;
  }

  /* QR modal layout: make content fill the panel neatly */
  #customQRModal .cw2-modal-body{
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    gap: 14px;
  }
  #custom-qr-canvas{
    display: block;
    max-width: 100%;
    height: auto;
    margin: 0 auto;
  }

  /* Created success block: centered + modest (no Bootstrap alert styling) */
  #cw2-created-success{
    text-align: center;
    margin-top: 1rem;
  }
  .cw2-created-banner{
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 10px 14px;
    border-radius: 12px;
    border: 1px solid rgba(25,135,84,.35);
    background: rgba(25,135,84,.06);
    color: #146c43;
    font-weight: 700;
  }
  .cw2-created-address{
    margin-top: 14px;
  }
  #cw2-new-address.cw2-address-display{
    display: inline-block;
    text-align: center;
    padding: .65rem .85rem !important;
    border-radius: 10px !important;
    background: #f8f9fa !important;
    border: 1px solid rgba(0,0,0,.08);
    max-width: 100%;
    word-break: break-all;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.95rem;
  }

  /* Modal overlay - fixed positioning with centering */
  .custom-modal { 
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.5);
    outline: none !important;
  }
  .custom-modal.hidden { 
    display: none !important; 
  }
  /* Polished modal container */
  .custom-modal .modal-content { 
    border-radius: 14px; 
    box-shadow: 0 22px 55px rgba(0,0,0,.28); 
    border: 1px solid rgba(0,0,0,.1);
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    max-height:90vh;
    overflow:hidden;
    background:#fff;
  }
  /* Widen wallet modals */
  #cw2-sendModal .modal-content,
  #cw2-receive .modal-content,
  #cw2-tk1 .modal-content,
  #cw2-tk2 .modal-content,
  #cw2-success .modal-content { width: min(94vw, 840px); }
  body.dark-theme .custom-modal .modal-content { 
    border-color: rgba(255,255,255,.12);
    box-shadow: 0 20px 60px rgba(0,0,0,.5);
    background-color: #1f1f1f;
  }

  @keyframes modalPop {
    0% { transform: scale(0.95); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }
  
  .cw2-modal-header {
    background: linear-gradient(135deg, #007bff 0%, #17a2b8 100%);
    color: white;
    padding: 1.25rem 1.5rem;
    display: flex; justify-content: space-between; align-self: center;
  }
  .cw2-modal-title { font-weight: 700; font-size: 1.2rem; }
  .cw2-modal-subtitle { font-size: 0.9rem; opacity: 0.9; margin-top: 2px; font-weight: 400; }
  .cw2-modal-body { padding: 2rem; overflow-y: auto; }
  .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; background: #f8f9fa; }

  .close-icon-white {
    background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; opacity: 0.8;
  }
  .close-icon-white:hover { opacity: 1; }

  /* ASSET SELECTION GRID */
  .cw2-asset-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
  /* ASSET SELECTION STYLES (Updated) */
  .cw2-asset-option { 
    border: 2px solid #eee; 
    border-radius: 12px; 
    padding: 1rem; 
    text-align: center; 
    cursor: pointer; 
    transition: all 0.2s ease;
    background: #fff; /* Ensure white background initially */
  }
  
  .cw2-asset-option:hover { 
    border-color: #007bff; 
    background: rgba(0,123,255,.05); 
  }
  
  /* FORZA L'ILLUMINAZIONE QUANDO SELEZIONATO */
  .cw2-asset-option.selected { 
    border: 2px solid #007bff !important;
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
    color: white !important;
    box-shadow: 0 0 0 3px rgba(0,123,255,.2), 0 4px 8px rgba(0,0,0,.15) !important;
    transform: scale(1.02) !important;
    font-weight: bold !important;
  }
  
  /* I colori delle icone e del testo devono diventare bianchi */
  .cw2-asset-option.selected .cw2-asset-icon,
  .cw2-asset-option.selected .cw2-asset-name,
  .cw2-asset-option.selected .cw2-asset-symbol {
    color: white !important;
  }

  /* PROGRESS STEPS */
  .cw2-creation-progress { margin-top: 0.85rem;
  margin-bottom: 1.5rem; background: #f8f9fa; padding: 1rem; border-radius: 10px; }
  .cw2-progress-title { font-weight: 700; margin-bottom: 0.8rem; font-size: 0.95rem; color: #555; }
  .cw2-steps { display: flex; flex-direction: column; gap: 0.5rem; }
  .cw2-step { display: flex; align-items: center; gap: 0.75rem; font-size: 0.9rem; color: #666; }
  .cw2-step-dot { 
    width: 12px; height: 12px; border-radius: 50%; background: #dee2e6; transition: all 0.3s ease;
  }
  .cw2-step.active { color: #007bff; font-weight: 600; }
  .cw2-step.active .cw2-step-dot { background: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.2); }
  .cw2-step.completed { color: #28a745; }
  .cw2-step.completed .cw2-step-dot { background: #28a745; }

  /* PIN ENTRY (toned down) */
  .cw2-pin-entry{
    background: transparent;
    border: 1px solid rgba(0,0,0,.08);
    padding: .75rem 1rem;
    border-radius: 12px;
    margin-top: .75rem;
    text-align: center;
  }
  .cw2-pin-entry .form-label{
    font-size: .9rem;
    color: #666;
    font-weight: 600;
    margin-bottom: .35rem;
  }
  .cw2-pin-entry input{
    font-size: 1.05rem;
    letter-spacing: .25rem;
    text-align: center;
    border: 1px solid #ced4da;
    border-radius: 10px;
    padding: .4rem .6rem;
    width: 100%;
    max-width: 180px;
    margin: .35rem auto .5rem;
    display: block;
  }
  .cw2-pin-entry input:focus{
    outline: none;
    box-shadow: none;
    border-color: #adb5bd;
  }
  .cw2-pin-entry .form-control:focus{ box-shadow: none !important; }
  #cw2-btn-submit-pin{
    padding: .35rem .85rem;
    font-size: .9rem;
    border-radius: 10px;
  }

  /* Lock asset selection during creation */
  .cw2-asset-option.locked{
    pointer-events: none;
    opacity: 0.92;
  }

  /* Make status message more modest */
  #cw2-status-text{
    font-weight: 600 !important;
    font-size: 0.95rem !important;
    color: #4b5563 !important;
  }
  #cw2-creation-status.cw2-status{
    padding: 8px 10px;
    margin-bottom: 0.85rem; /* space from progress list */
  }

  /* UTILS */
  .d-none { display: none !important; }
  .cw2-field-group { margin-bottom: 1rem; }
  .cw2-field-group label { font-weight: 600; display: block; margin-bottom: 0.5rem; }
  .form-control, .form-select { padding: 10px; border-radius: 8px; border: 1px solid #dee2e6; width: 100%; }

  /* --- STATUS TEXT: remove blue "halo"/glow from Bootstrap alerts --- */
  #cw2-creation-status.cw2-status{
  margin-top: 1.5rem;
  text-align: center;
  display: block;
  padding: 10px 14px;
  border-radius: 10px;
  border: 1px solid transparent;
}

#cw2-creation-status.cw2-status-success { border-color: #198754; }
#cw2-creation-status.cw2-status-error   { border-color: #dc3545; }
#cw2-creation-status.cw2-status-info    { border-color: #0dcaf0; }
#cw2-creation-status.cw2-status-neutral { border-color: transparent; }


  /* Force modal headers to span the whole panel (fix narrow blue header in QR modal) */
  .custom-modal .cw2-modal-header{
    width: 100% !important;
    align-self: stretch !important;
  }


  /* Scan buttons: modest size + icon spacing */
  .cw2-scan-btn{
    padding: 8px 14px;
    font-size: .95rem;
    border-radius: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    line-height: 1;
    white-space: nowrap;
  }

  /* QR Scan modal: make camera area fill the modal nicely */
  #scanQRModal .cw2-modal-body{
    padding: 1.25rem 1.5rem;
  }
  #qr-reader{
    width: 100%;
  }
  #qr-reader video{
    width: 100% !important;
    height: auto !important;
    border-radius: 12px;
  }
  /* html5-qrcode sometimes injects a bordered box */
  #qr-reader__dashboard_section,
  #qr-reader__status_span{
    font-size: .9rem;
  }

</style>

<main class="container-panel">
  
  <div class="cw2-blue-panel">
    
    <div class="cw2-panel-header">
      <div class="cw2-panel-title">
        <h1>Cold Wallet</h1>
        <p>Build a local 2‑of‑3 cold wallet and expose QR requests</p>
      </div>
      <div class="security-badge-container">
        <div class="security-badge">
          <i class="fas fa-shield-alt"></i>
          <span>MPC-TSS Wallet · 2-of-3 Toughkeys</span>
        </div>
      </div>
    </div>

    <div class="cw2-wallet-section" style="margin-top: 1.5rem; display: flex; flex-direction: column; align-items: center; text-align: center;">
      <div style="width: 100%; max-width: 500px;">
        <label for="existing-wallets" class="cw2-selector-label">Select Wallet</label>
        <select id="existing-wallets" class="cw2-address-selector">
            <option value="" selected>-- Create New --</option>
        </select>
      </div>
    </div>

    <hr style="border-color: rgba(255,255,255,0.2); margin: 2rem 0;">

    <div class="cw2-operations-area" style="text-align: center;">
        
        <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; align-items: center; margin-bottom: 1rem;">
            <button id="btn-open-create-modal" class="btn btn-light" style="font-weight: 700; color: #0056b3; min-width: 200px;">
                <i class="fas fa-plus-circle me-2"></i> Create new wallet
            </button>

            <button id="btn-show-qr" class="btn btn-outline-light" disabled style="min-width: 180px;">
                <i class="fas fa-qrcode me-2"></i> Show Address QR
            </button>
        </div>

        <div id="created-address-wrap" class="d-none" style="margin-top: 1.5rem;">
          <div style="display: inline-flex; align-items: center; gap: 12px; background: rgba(0, 0, 0, 0.2); padding: 8px 24px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(5px);">
              <span style="color: rgba(255,255,255,0.7); font-size: 0.9rem; font-weight: 600;">ADDRESS</span>
              <code id="created-address" style="color: white; font-family: 'Courier New', monospace; font-size: 1.1rem; font-weight: 600;"></code>
              <button id="btn-copy-addr" class="btn btn-sm text-white p-0" title="Copy"><i class="fas fa-copy"></i></button>
          </div>
        </div>

        <p id="main-prompt-text" style="margin-top: 1rem; opacity: 0.8;">Ready to start.</p>

    </div>
  </div>

  <div class="cw2-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem;">
    <div class="card" style="background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.05);">
      <div style="display: flex; gap: 10px; margin-bottom: 1rem; font-weight: 700; color: #333;">
        <i class="fas fa-paper-plane" style="color: #007bff;"></i> Transaction Creation
      </div>
      <div class="cw2-field-group mb-3">
          <label>Receiver Address</label>
          <div style="display: flex; gap: 10px;">
              <input type="text" id="recipient-address" class="form-control" placeholder="0x...">
              <button class="btn btn-outline-dark cw2-scan-btn" id="btn-scan-recipient" type="button"><i class="fas fa-camera me-2"></i><span>Scan</span></button>
          </div>
      </div>
      <div class="cw2-field-group">
          <label>Amount & Generate</label>
          <div style="display: flex; gap: 10px;">
              <input type="number" id="transaction-amount" class="form-control" placeholder="0.00">
              <button id="btn-show-tx-qr" class="btn btn-dark cw2-scan-btn" disabled type="button" style="white-space: nowrap;"><i class="fas fa-qrcode"></i><span>Show QR</span></button>
          </div>
      </div>
    </div>

    <div class="card" style="background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.05);">
      <div style="display: flex; gap: 10px; margin-bottom: 1rem; font-weight: 700; color: #333;">
        <i class="fas fa-file-signature" style="color: #007bff;"></i> Sign Transaction (2-of-3)
      </div>
      <div class="cw2-field-group mb-3">
          <label>Transaction Hash</label>
          <div style="display: flex; gap: 10px;">
              <input type="text" id="tx-hash-display" class="form-control" placeholder="Waiting scan..." readonly>
              <button id="btn-scan-qr" class="btn btn-outline-primary cw2-scan-btn" type="button"><i class="fas fa-camera me-2"></i><span>Scan</span></button>
          </div>
      </div>
      <div class="cw2-field-group">
           <label>Signer Device & Action</label>
           <div style="display: flex; gap: 10px;">
               <select id="signer-select" class="form-select">
                  <option value="" selected disabled>Select Wallet First</option>
              </select>
              <button id="btn-sign-tx" class="btn btn-success" disabled style="white-space: nowrap;">Sign (0/2)</button>
           </div>
      </div>
    </div>
  </div>

</main>

<div id="cw2-addWallet" class="custom-modal hidden" role="dialog" aria-modal="true" aria-labelledby="cw2-addWalletTitle">
  <div class="custom-modal-content" style="max-width: 600px;">
    <div class="cw2-modal-header">
      <div style="flex: 1; text-align: center;">
        <div class="cw2-modal-title"><i class="fas fa-plus-circle me-2"></i>Create New Wallet</div>
        <div class="cw2-modal-subtitle">3 Toughkey HSMs · Threshold Security</div>
      </div>
      <button class="close-icon-white" id="btn-close-add-wallet" type="button" aria-label="Close">&times;</button>
    </div>
    
    <div class="cw2-modal-body">
      
      <div id="cw2-asset-selection" class="cw2-creation-step">
        <div class="cw2-field-group" style="margin-bottom: 1.5rem; text-align: center;">
          <label style="display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 0.8rem;">
            <i class="fas fa-pen"></i>
            <span>Wallet Name</span>
          </label>
          <input type="text" id="cw2-wallet-name-input" class="form-control" placeholder="e.g. My Cold Wallet" maxlength="30" autocomplete="off" style="text-align: center; max-width: 300px; margin: 0 auto;" />
        </div>
        <div class="cw2-field-group">
          <label style="display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 1rem;">
            <i class="fas fa-coins"></i>
            <span>Select Wallet Type</span>
          </label>
          
          <div class="cw2-asset-grid">
            <div class="cw2-asset-option" data-asset="BTC">
              <div class="cw2-asset-icon">₿</div>
              <div class="cw2-asset-name">Bitcoin</div>
              <div class="cw2-asset-symbol">BTC</div>
            </div>
            <div class="cw2-asset-option" data-asset="ETH">
              <div class="cw2-asset-icon">Ξ</div>
              <div class="cw2-asset-name">Ethereum</div>
              <div class="cw2-asset-symbol">ETH</div>
            </div>
            <div class="cw2-asset-option" data-asset="XRP">
              <div class="cw2-asset-icon">⊕</div>
              <div class="cw2-asset-name">XRP Ledger</div>
              <div class="cw2-asset-symbol">XRP</div>
            </div>
          </div>
        </div>
        
        <div id="cw2-creation-status" style="margin-top: 1.5rem; text-align: center;">
          <p id="cw2-status-text" style="font-weight: 600; font-size: 1.1em; margin: 0; color: #0c5460;">
            Select a wallet type to begin creation
          </p>
        </div>
      </div>

	  <div id="cw2-creation-progress" class="cw2-creation-progress d-none">
          <div class="cw2-progress-title">Wallet Creation Process</div>
          <div class="cw2-steps">
            <div class="cw2-step" id="cw2-step-1"><div class="cw2-step-dot"></div><span>Initialize & fetch device info</span></div>
            <div class="cw2-step" id="cw2-step-2"><div class="cw2-step-dot"></div><span>Enroll Toughkey 1 (Enter PIN)</span></div>
            <div class="cw2-step" id="cw2-step-3"><div class="cw2-step-dot"></div><span>Enroll Toughkey 2 (Enter PIN)</span></div>
            <div class="cw2-step" id="cw2-step-4"><div class="cw2-step-dot"></div><span>Enroll Toughkey 3 (Enter PIN)</span></div>
            <div class="cw2-step" id="cw2-step-5"><div class="cw2-step-dot"></div><span>TSS Key Shares Created (3/3)</span></div>
            <div class="cw2-step" id="cw2-step-6"><div class="cw2-step-dot"></div><span>Wallet Created</span></div>
          </div>
      </div>
      
	  <div id="cw2-progress-summary" class="cw2-progress-summary d-none">
          <div class="cw2-progress-badges">
            <span class="badge bg-primary">Enrolled: <span id="cw2-enrolled">0</span> / 3</span>
            <span class="badge bg-info text-white">Shares: <span id="cw2-shares">0</span> / 3</span>
          </div>
      </div>

	  <div id="cw2-pin-section" class="cw2-pin-entry d-none">
          <label class="form-label">Enter PIN for <strong id="cw2-pin-label">Toughkey 1</strong></label>
          <input type="password" id="cw2-pin-input" class="form-control" placeholder="••••" inputmode="numeric" maxlength="12" autocomplete="off"/>
          <button id="cw2-btn-submit-pin" class="btn btn-success mt-2">Continue</button>
      </div>

	  <div id="cw2-created-success" class="d-none">
          <div class="cw2-created-banner">
            <i class="fas fa-check-circle"></i>
            <span>Wallet Created Successfully!</span>
          </div>
          <div class="cw2-created-address">
            <label>New Wallet Address:</label>
            <div id="cw2-new-address" class="cw2-address-display"></div>
          </div>
      </div>

    </div>

    <div class="modal-footer">
      <button class="btn btn-light border" id="btn-cancel-creation">Cancel</button>
      <button class="btn btn-primary" id="btn-start-ceremony" disabled>Start Creation</button>
    </div>
  </div>
</div>

<div id="customQRModal" class="custom-modal hidden">
  <div class="custom-modal-content" style="max-width: 100%; text-align: center;">
    <div class="cw2-modal-header">
        <div class="cw2-modal-title" id="cw2-custom-qr-title">Wallet QR</div>
        <button class="close-icon-white" id="btn-close-custom-qr">&times;</button>
    </div>
    <div class="cw2-modal-body">
        <canvas id="custom-qr-canvas" width="250" height="250"></canvas>
        <button class="btn btn-light border w-100 mt-3" id="btn-close-custom-qr-2">Close</button>
    </div>
  </div>
</div>

<div id="scanQRModal" class="custom-modal hidden">
    <div class="custom-modal-content" style="max-width: 100%; text-align: center;">
      <div class="cw2-modal-header">
        <div class="cw2-modal-title">Scan QR</div>
        <button class="close-icon-white" id="btn-close-scan">&times;</button>
      </div>
      <div class="cw2-modal-body">
         <div id="qr-reader"></div>
         <p class="text-muted small mt-2 text-center">Point camera at QR code</p>
      </div>
    </div>
</div>


<div id="cw2SignPinModal" class="custom-modal hidden" role="dialog" aria-modal="true" aria-labelledby="cw2SignPinTitle">
  <div class="custom-modal-content" style="max-width: 100%;">
    <div class="cw2-modal-header">
      <div class="cw2-modal-title" id="cw2SignPinTitle">Enter PIN</div>
      <button class="close-icon-white" id="btn-close-sign-pin" aria-label="Close">&times;</button>
    </div>
    <div class="cw2-modal-body" style="text-align:left;">
      <div class="text-muted small mb-2" id="cw2SignPinLabel">Device</div>
      <input id="cw2-sign-pin-input" type="password" class="form-control" autocomplete="off" inputmode="numeric" placeholder="PIN" />
      <div class="d-flex gap-2 mt-3">
        <button id="btn-cancel-sign-pin" type="button" class="btn btn-outline-secondary w-50">Cancel</button>
        <button id="btn-submit-sign-pin" type="button" class="btn btn-primary w-50">Confirm</button>
      </div>
    </div>
  </div>
</div>

<script src="/plug-ins/coldwallet/assets/js/tssparticipant.js"></script>
<script>
  window.CW_ENV = {
    WS_CARD_1: "<%= (process.env.WS_CARD_1 || 'ws://localhost:8001/ws') %>",
    WS_CARD_2: "<%= (process.env.WS_CARD_2 || 'ws://localhost:8002/ws') %>",
    WS_CARD_3: "<%= (process.env.WS_CARD_3 || 'ws://localhost:8003/ws') %>",
    WS_MANAGER: "<%= (process.env.WS_MANAGER || 'wss://tsskeymanager-sdk.azurewebsites.net/ws') %>"
  };
</script>
<script>
  // Compatibility: some legacy code expects a global cw2_handleDecodedText
  // (e.g. inside /js/coldwallet.js). Provide a safe default.
  window.cw2_handleDecodedText = window.cw2_handleDecodedText || function(decodedText, targetInputId){
    try{
      const el = document.getElementById(targetInputId);
      if(el){
        el.value = (decodedText || '').trim();
        el.dispatchEvent(new Event('input', { bubbles: true }));
      }
    }catch(e){}
  };
</script>
<script src="/js/coldwallet.js"></script>

<script type="module">
/* -----------------------------------------------------------
   JAVASCRIPT LOGIC ADAPTED FOR NEW MODAL FLOW
   ----------------------------------------------------------- */

let selectedAsset = null;
let walletName = null;
let wallet = { address: null, partyId: null, participants: [], token: null };
let cachedParties = [];
let pendingPinResolve = null;
function extractSerialFromPinCheck(resp) {
    if (!resp) return null;
    if (typeof resp === 'string') return resp || null;
    
    // Check various properties where the serial might be hidden depending on API response structure
    const p = resp.payload || resp.resultObject || resp;
    
    return (
        p.SerialNumber ||
        p.serialNumber ||
        (typeof p.Message === 'string' ? p.Message : null) ||
        (typeof p.message === 'string' ? p.message : null) ||
        null
    );
}

const createModal = document.getElementById('cw2-addWallet');
const btnOpenCreate = document.getElementById('btn-open-create-modal');
const btnCloseCreate = document.getElementById('btn-close-add-wallet');
const btnCancelCreate = document.getElementById('btn-cancel-creation');
const btnStartCeremony = document.getElementById('btn-start-ceremony');

function updateCreateButtonState() {
    const walletSelect = document.getElementById('existing-wallets');
    // Enable "Create new wallet" only when "-- Create New --" (empty value) is selected
    const isCreateNew = !walletSelect || !walletSelect.value;
    if (btnOpenCreate) btnOpenCreate.disabled = !isCreateNew;
}


if (btnOpenCreate) btnOpenCreate.addEventListener('click', () => {
    resetCreationModal();
    if (createModal) createModal.classList.remove('hidden');
});

function closeCreationModal() {
    if (createModal) createModal.classList.add('hidden');
}
if (btnCloseCreate) btnCloseCreate.addEventListener('click', closeCreationModal);
if (btnCancelCreate) btnCancelCreate.addEventListener('click', closeCreationModal);

function resetCreationModal() {
    selectedAsset = null;
    walletName = null;
    
    // 1. Rimuovi selezione visiva
    document.querySelectorAll('.cw2-asset-option').forEach(el => { el.classList.remove('selected'); el.classList.remove('locked'); });
    
    // 2. Reset visibilità sezioni
    const elAssetSel = document.getElementById('cw2-asset-selection');
    const elProcess = document.getElementById('cw2-creation-progress');
    const elSuccess = document.getElementById('cw2-created-success');
    const elStatus = document.getElementById('cw2-creation-status');

    if(elAssetSel) elAssetSel.classList.remove('d-none');
    if(elProcess) elProcess.classList.add('d-none');
    if(elSuccess) elSuccess.classList.add('d-none');
    
    // 3. Reset Messaggio (Neutro, senza sfondo verde/blu)
    if(elStatus) elStatus.classList.remove('d-none');
    cw2_setStatusMessage('Select a wallet type to begin creation', 'neutral');

    // 4. Reset Bottone
    if(btnStartCeremony) {
        btnStartCeremony.disabled = true;
        btnStartCeremony.textContent = "Start Creation";
        btnStartCeremony.classList.remove('d-none'); 
    }
    
    if(btnCancelCreate) {
        btnCancelCreate.textContent = "Cancel";
        btnCancelCreate.disabled = false;
    }
    
    for(let i=1; i<=6; i++) setStep(i, '');
    updateStats(0, 0);
}

// GESTORE CLICK ASSET (Logica ConsumerWallet2)
const assetOptions = document.querySelectorAll('.cw2-asset-option');
assetOptions.forEach(opt => {
    opt.addEventListener('click', () => {
        // 1. Rimuovi 'selected' da tutti gli altri
        assetOptions.forEach(el => el.classList.remove('selected'));
        
        // 2. Aggiungi 'selected' a quello cliccato
        opt.classList.add('selected');
        
        // 3. Aggiorna variabile globale
        selectedAsset = opt.getAttribute('data-asset');
        
        // 4. Aggiorna Stato: Testo + Sfondo Verde
        cw2_setStatusMessage(`${selectedAsset} wallet selected. Ready to create.`, 'success');
        
        // 5. Abilita bottone
        if(btnStartCeremony) btnStartCeremony.disabled = false;
    });
});

if (btnStartCeremony) btnStartCeremony.addEventListener('click', () => {
    if (!selectedAsset) return;

    // Keep the asset options visible; show progress under them
    document.getElementById('cw2-creation-progress').classList.remove('d-none');
    document.getElementById('cw2-creation-progress').scrollIntoView({ behavior: 'smooth', block: 'start' });
    document.getElementById('cw2-creation-status').classList.remove('d-none');

    // Lock asset selection to avoid changing mid-ceremony
    document.querySelectorAll('.cw2-asset-option').forEach(el => el.classList.add('locked'));

    btnStartCeremony.disabled = true;
    btnStartCeremony.textContent = "Creating...";
    btnCancelCreate.disabled = true;
    startWalletCreation();
});

function setStep(num, status) {
    const step = document.getElementById(`cw2-step-${num}`);
    if(!step) return;
    step.classList.remove('active', 'completed');
    if(status) step.classList.add(status);
}

function updateStats(enrolled, shares) {
    document.getElementById('cw2-enrolled').textContent = enrolled;
    document.getElementById('cw2-shares').textContent = shares;
}

function setModalStatus(text) {
    document.getElementById('cw2-status-text').textContent = text;
}

function cw2_setStatusMessage(message, type = 'neutral') {
  const statusElement = document.getElementById('cw2-status-text');
  const statusContainer = document.getElementById('cw2-creation-status');

  if (statusElement) {
      statusElement.textContent = message;
      // FIX: Ensure the text element itself is visible (it gets hidden on success)
      statusElement.classList.remove('d-none'); 
      statusElement.style.display = 'block'; 
  }

  if (statusContainer) {
    // Remove old specific alert classes
    statusContainer.classList.remove(
      'alert', 'alert-success', 'alert-danger', 'alert-info',
      'cw2-status-success', 'cw2-status-error', 'cw2-status-info', 'cw2-status-neutral'
    );
    // Add custom base class
    statusContainer.classList.add('cw2-status');

    // Apply new style based on type
    if (type === 'success') statusContainer.classList.add('cw2-status-success');
    else if (type === 'error') statusContainer.classList.add('cw2-status-error');
    else if (type === 'info') statusContainer.classList.add('cw2-status-info');
    else statusContainer.classList.add('cw2-status-neutral');
    
    // Ensure the container is also visible
    statusContainer.classList.remove('d-none');
  }
}

const pinSection = document.getElementById('cw2-pin-section');
const pinInput = document.getElementById('cw2-pin-input');
const pinLabel = document.getElementById('cw2-pin-label');
const btnSubmitPin = document.getElementById('cw2-btn-submit-pin');

if (btnSubmitPin) btnSubmitPin.addEventListener('click', submitPin);
if (pinInput) pinInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') submitPin(); });

function askPin(cardName) {
    pinSection.classList.remove('d-none');
    pinLabel.textContent = cardName;
    pinInput.value = '';
    pinInput.focus();
    return new Promise((resolve) => {
        pendingPinResolve = resolve;
    });
}

function submitPin() {
    const val = pinInput.value.trim();
    if(!val) return; 
    pinSection.classList.add('d-none');
    pinInput.value = '';
    if(pendingPinResolve) {
        pendingPinResolve(val);
        pendingPinResolve = null;
    }
}

const sleep = (ms) => new Promise(r => setTimeout(r, ms));

async function startWalletCreation() {
  try {
    updateStats(0,0);
    
    // Initialize exclusion list and map for member serials
    // Using simple object keyed by index to be robust
    let SerialNumbersToExclude = []; 
    let memberSerials = {}; 

    setStep(1, 'active');
    setModalStatus("Initializing Party on Server...");
    
    if (!walletName) {
        walletName = document.getElementById('cw2-wallet-name-input').value.trim();
    }

    // 1. CREATE PARTY
    const createPartyData = {
      assets: [selectedAsset],
      size: 3,
      threshold: 2,
      thresholdConfig: [],
      walletName: walletName
    };
    
    const createPartyres = await fetch('http://localhost:44379/api/Party/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(createPartyData)
    });
    const partyData = await createPartyres.json();
    const partyId = partyData.resultObject[0];
    
    // 2. ADD MEMBERS
    const AddMembersToPartyData = {
      partyID: partyId,
      members: [
        { externalPartyMemberID: "toughkey1-member", level: 0, name: "Toughkey 1", label: "Toughkey 1" },
        { externalPartyMemberID: "toughkey2-member", level: 0, name: "Toughkey 2", label: "Toughkey 2" },
        { externalPartyMemberID: "toughkey3-member", level: 0, name: "Toughkey 3", label: "Toughkey 3" }
      ]
    };
    
    const AddMembersRes = await fetch("http://localhost:44379" + '/api/Party/addMembers', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(AddMembersToPartyData)
    });
    const AddMembersData = await AddMembersRes.json();
    const members = AddMembersData.resultObject;
    wallet.participants = members;
    
    setStep(1, 'completed');

    let enrolledCount = 0;
    let memberCredentials = {}; // Stores encrypted PINs by Index

    // --- AUTHORIZATION LOOP ---
    for (let i = 0; i < members.length; i++) {
        const member = members[i];
        const stepNum = i + 2; 
        setStep(stepNum, 'active');
        
        let attempts = 0;
        let isAuthorized = false;

        while (!isAuthorized && attempts < 3) {
            
            if (attempts > 0) {
                cw2_setStatusMessage(`Wrong PIN. Try again (${attempts}/3).`, 'error');
            } else {
                cw2_setStatusMessage(`Enter PIN for ${member.name}`, 'info');
            }

            const pin = await askPin(member.name);
            const encryptedPin = encryptUsingAES(pin);
            
            if(i == 0) {
              cw2_setStatusMessage(`Using inserted ${member.name}, do not remove.`, 'info');
            } else {
              cw2_setStatusMessage(`Tap or insert ${member.name} to authorize...`, 'info');
            }
            
            // Send current exclusion list
            const authBody = JSON.stringify({ 
                participantId: member.id, 
                pin: encryptedPin, 
                SerialNumbersToExclude: SerialNumbersToExclude 
            });
            
            const authRes = await fetch(`http://localhost:44379/api/Party/authorize`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: authBody
            });

            const responseData = await authRes.json();
            
            
            const isLogicalError = responseData.error || 
                                   responseData.Error || 
                                   (responseData.Message && responseData.Message.toLowerCase().includes("wrong")) ||
                                   (responseData.message && responseData.message.toLowerCase().includes("wrong"));

            if (!authRes.ok || isLogicalError) {
                const errorMsg = responseData.Message || responseData.message || responseData.error || "Unknown Error";
                
                if (errorMsg.toLowerCase().includes("wrong pin")) {
                    attempts++;
                    if (attempts >= 3) {
                        cw2_setStatusMessage("Wrong PIN entered 3 times. Creation aborted.", 'error');
                        const pinSec = document.getElementById('cw2-pin-section');
                        if(pinSec) pinSec.classList.add('d-none');
                        throw new Error("PIN attempts exceeded");
                    }
                } else {
                    cw2_setStatusMessage(`Error: ${errorMsg}`, 'error');
                    throw new Error(`Auth failed: ${errorMsg}`);
                }
            } else {
                isAuthorized = true;
                // DEBUG: Log extracting logic
                  const _serial = extractSerialFromPinCheck(responseData);
                  console.log(`[Auth] Member index ${i} (${member.name}). Extracted Serial: ${_serial}`);

                  if (_serial) {
                      if (!SerialNumbersToExclude.includes(_serial)) {
                          SerialNumbersToExclude.push(_serial);
                      }
                      // Save serial mapped by INDEX to be safe
                      memberSerials[i] = _serial;
                  }

                memberCredentials[i] = encryptedPin; // Store creds by Index
                enrolledCount++;
                updateStats(enrolledCount, 0);
                setStep(stepNum, 'completed');
                
                if (i == 0) {
                  cw2_setStatusMessage(`Please leave ${member.name} inserted, follow the next prompt.`, 'success');
                } else {
                  cw2_setStatusMessage(`Remove ${member.name} and wait...`, 'success');
                }
                await sleep(3000);
            }
        }
    }

    // --- ACTIVATION START ---
    setStep(5, 'active');
    setModalStatus("Starting Activation...");
    
    await fetch("http://localhost:44379" + '/api/Activation/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ partyID: partyId })
    });

    // --- SAVE SHARES LOOP ---
    // Using 'let i' loop to access the correct serial via index
    let sharesCount = 0;
    for (let i = 0; i < members.length; i++) {
        const member = members[i];
        
        if (i == 0) {
          setModalStatus(`Saving the share in ${member.name} ..`);
        } else {
          setModalStatus(`Tap or insert ${member.name} to save the private share..`);
        }
        
        const reusedEncryptedPin = memberCredentials[i];
        
        // LOGIC: Filter exclusion list using the INDEX
        const currentMemberSerial = memberSerials[i];
        
        // Create specific list: All serials MINUS the current one
        const specificExclusionList = SerialNumbersToExclude.filter(s => s !== currentMemberSerial);
        
        console.log(`[Save] Index ${i} (${member.name}). Serial: ${currentMemberSerial}. Exclude List Size: ${specificExclusionList.length}`);

        const saveBody = JSON.stringify({ 
            partyId: partyId,
            participantId: member.id, 
            pin: reusedEncryptedPin, 
            SerialNumbersToExclude: specificExclusionList 
        });
        
        const saveRes = await fetch(`http://localhost:44379/api/Party/save`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: saveBody
        });
        
        if (!saveRes.ok) throw new Error(`Save share failed for ${member.name}`);
        
        sharesCount++;
        updateStats(enrolledCount, sharesCount);
        if (i == 0) {
           setModalStatus(`Keep ${member.name} connected and wait...`);
        } else {
           setModalStatus(`Remove ${member.name}...`);
        }
        await sleep(2000);
    }
    
    setStep(5, 'completed');

    // --- FINALIZE ---
    setStep(6, 'active');
    setModalStatus("Finalizing Wallet...");
    
    const EndActivationRes = await fetch("http://localhost:44379" + '/api/Activation/end', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ partyID: partyId }) 
    });
    const EndResData = await EndActivationRes.json();
    const finalAddr = EndResData.resultObject.address;
    
    setStep(6, 'completed');
    
    document.getElementById('cw2-created-success').classList.remove('d-none');
    document.getElementById('cw2-new-address').textContent = finalAddr;
    document.getElementById('cw2-status-text').classList.add('d-none');
    
    btnCancelCreate.textContent = "Close";
    btnCancelCreate.disabled = false;
    btnStartCeremony.classList.add('d-none');

    const walletSelect = document.getElementById('existing-wallets');
    const opt = document.createElement('option');
    opt.value = finalAddr;
    const shortAddr = finalAddr.length > 12 
        ? finalAddr.substring(0, 12) + '...' 
        : finalAddr;

    const namePrefix = walletName ? `${walletName} — ` : '';
    opt.textContent = `${namePrefix}${shortAddr} (${selectedAsset})`;

    opt.dataset.partyId = partyId;
    opt.dataset.asset = selectedAsset;
    opt.dataset.walletName = walletName;
    opt.selected = true;
    walletSelect.appendChild(opt);
    
    updateMainInterface(finalAddr, selectedAsset, walletName);
    loadExistingWallets(); 

  } catch (e) {
    console.error(e);
    setModalStatus("Error: " + e.message);
    btnStartCeremony.disabled = false;
    btnStartCeremony.textContent = "Retry";
    btnCancelCreate.disabled = false;
  }
}

function updateMainInterface(address, asset) {
    const addrWrap = document.getElementById('created-address-wrap');
    const addrCode = document.getElementById('created-address');
    const mainPrompt = document.getElementById('main-prompt-text');
    
    addrCode.textContent = address;
    addrWrap.classList.remove('d-none');
    mainPrompt.textContent = `Active Wallet: ${asset}`;
    
    document.getElementById('btn-show-qr').disabled = false;
    // TX QR should activate only when recipient + amount are valid
    updateTxQrButtonState();
    
    wallet.address = address;
    wallet.crypto = asset;
}

function encryptUsingAES(plainText) {
    const keyBytes = aesjs.utils.utf8.toBytes('4512631236589784');
    const ivBytes = aesjs.utils.utf8.toBytes('4512631236589784');
    const textBytes = aesjs.utils.utf8.toBytes(plainText);
    const padded = aesjs.padding.pkcs7.pad(textBytes.slice());
    const aesCbc = new aesjs.ModeOfOperation.cbc(keyBytes, ivBytes);
    return bytesToBase64(aesCbc.encrypt(padded));
}
function bytesToBase64(bytes) {
    let bin = '';
    for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
    return btoa(bin);
}

async function loadExistingWallets(selectAddress = null, fallbackParty = null) {
    try {
        const res = await fetch('http://localhost:44379/api/Party');
        const data = await res.json();
        cachedParties = data.resultObject || [];

        // If API doesn't yet return the freshly created wallet, keep a fallback
        if (fallbackParty && fallbackParty.partyAddress) {
            const exists = cachedParties.some(p => p.partyAddress === fallbackParty.partyAddress);
            if (!exists) cachedParties.push(fallbackParty);
        }

        const select = document.getElementById('existing-wallets');
        select.innerHTML = '<option value="">-- Create New --</option>';

        cachedParties.forEach(p => {
            if (p.partyAddress) {
                const opt = document.createElement('option');
                
                opt.value = p.partyAddress; 
                
                const shortAddr = p.partyAddress.length > 12 
                    ? p.partyAddress.substring(0, 12) + '...' 
                    : p.partyAddress;
                
                const namePrefix = p.walletName ? `${p.walletName} — ` : '';
                
                opt.textContent = `${namePrefix}${shortAddr} (${p.assetCode})`;

                opt.dataset.partyId = p.id || p.partyGUID;
                opt.dataset.asset = p.assetCode;
                if(p.walletName) opt.dataset.walletName = p.walletName;
                
                select.appendChild(opt);
            }
        });

        if (selectAddress) {
            select.value = selectAddress;
            // Force UI refresh
            select.dispatchEvent(new Event('change'));
        } else {
            select.value = '';
            updateCreateButtonState();
        }
    } catch (e) { 
        console.error("Error loading wallets", e); 
        updateCreateButtonState();
    }
}

document.getElementById('existing-wallets')?.addEventListener('change', (e) => {
    const val = e.target.value;

    if (val) {
        const opt = e.target.selectedOptions[0];
        const pid = opt.dataset.partyId;
        const asset = opt.dataset.asset;


        wallet.partyId = pid || null;
        wallet.crypto = asset || null;
        const partyData = cachedParties.find(p => (p.id == pid || p.partyGUID == pid));
        if (partyData) {
            wallet.participants = partyData.members || partyData.partyMembers || [];
            updateSignerDropdown();
        }

        updateMainInterface(val, asset);
    } else {
        document.getElementById('created-address-wrap').classList.add('d-none');
        document.getElementById('btn-show-qr').disabled = true;
        document.getElementById('btn-show-tx-qr').disabled = true;
        document.getElementById('main-prompt-text').textContent = "Ready to start.";
        wallet.address = null;
        wallet.partyId = null;
        wallet.crypto = null;
        wallet.participants = [];
        updateSignerDropdown();
    }

    // Enable "Create new wallet" only when "-- Create New --" is selected
    updateCreateButtonState();
});

function updateSignerDropdown() {
    const s = document.getElementById('signer-select');
    s.innerHTML = '<option value="" selected disabled>Select TK</option>';
    if(wallet.participants) {
        wallet.participants.forEach((p, idx) => {
            const o = document.createElement('option');
            o.value = p.id;
            o.textContent = `Toughkey ${idx+1}`;
            s.appendChild(o);
        });
    }
}

loadExistingWallets();

const qrModal = document.getElementById('customQRModal');
const btnShowQr = document.getElementById('btn-show-qr');
const btnCloseQr1 = document.getElementById('btn-close-custom-qr');
const btnCloseQr2 = document.getElementById('btn-close-custom-qr-2');
const qrModalTitle = document.getElementById('cw2-custom-qr-title');

if(btnShowQr) {
    btnShowQr.addEventListener('click', () => {
        if(wallet.address) renderQR(wallet.address, 'Wallet QR');
    });
}

// Transaction Creation - Receiver Address must be editable (manual + scan)
// and "Show QR" becomes active only when we have a valid recipient + amount.
const recipientInput = document.getElementById('recipient-address');
const amountInput = document.getElementById('transaction-amount');
const btnShowTxQr = document.getElementById('btn-show-tx-qr');

function updateTxQrButtonState() {
    const hasWallet = !!wallet.address;
    const recipient = (recipientInput?.value || '').trim();
    const amountStr = (amountInput?.value || '').trim();
    const amountNum = Number(amountStr);

    const isValid = hasWallet && recipient.length > 0 && amountStr.length > 0 && !Number.isNaN(amountNum) && amountNum > 0;
    if (btnShowTxQr) btnShowTxQr.disabled = !isValid;
}

if (recipientInput) {
    recipientInput.removeAttribute('readonly');
    recipientInput.disabled = false;
    recipientInput.addEventListener('input', updateTxQrButtonState);
}

if (amountInput) {
    amountInput.addEventListener('input', updateTxQrButtonState);
}

if (btnShowTxQr) {
    btnShowTxQr.addEventListener('click', () => {
        if (!wallet.address) return;

        const recipient = (recipientInput?.value || '').trim();
        const amount = (amountInput?.value || '').trim();
        const amountNum = Number(amount);

        if (!recipient || !amount || Number.isNaN(amountNum) || amountNum <= 0) return;

        // Payload expected by the mobile app (Transaction Creation QR)
        // {
        //   address: "<sender>",
        //   to: "<receiver>",
        //   amount: "<decimal string>",
        //   crypto: "BTC|ETH|XRP",
        //   action: "transaction"
        // }
        const txPayload = JSON.stringify({
            address: wallet.address,
            to: recipient,
            amount: amount,
            crypto: (wallet.crypto || selectedAsset || '').toString(),
            walletName: walletName,
            action: "transaction"
        });

        renderQR(txPayload, 'Prepare Transaction QR');
    });
}

// Set initial state
updateTxQrButtonState();


if(btnCloseQr1) btnCloseQr1.addEventListener('click', () => qrModal.classList.add('hidden'));
if(btnCloseQr2) btnCloseQr2.addEventListener('click', () => qrModal.classList.add('hidden'));

function renderQR(txt, title = 'Wallet QR') {
    if (qrModalTitle) qrModalTitle.textContent = title;
    if (qrModal) qrModal.classList.remove('hidden');
    const canvas = document.getElementById('custom-qr-canvas');
    if (canvas) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, 250, 250);
        new QRious({ element: canvas, value: txt, size: 250 });
    }
}


// -----------------------------------------------------------

// ============================================================
// SIGN TRANSACTION (2-of-3) — restored scan+enable behavior
// ============================================================
let messageToSign = null;
let rawTransaction = null;
let currentSessionId = null;
let currentSignatures = new Set();

const btnSignTx = document.getElementById('btn-sign-tx');
const signerSelect = document.getElementById('signer-select');
const txHashDisplay = document.getElementById('tx-hash-display');

function setMainPrompt(text) {
  const el = document.getElementById('main-prompt-text');
  if (el) el.textContent = text || '';
}

function resetSignatureState({ clearHash = true } = {}) {
  messageToSign = null;
  rawTransaction = null;
  currentSessionId = null;
  currentSignatures.clear();

  if (btnSignTx) {
    btnSignTx.disabled = true;
    btnSignTx.textContent = 'Sign (0/2)';
    btnSignTx.classList.remove('btn-primary');
    btnSignTx.classList.add('btn-success');
    btnSignTx.onclick = null;
  }
  if (txHashDisplay && clearHash) txHashDisplay.value = '';
}

// Reset when wallet changes
document.getElementById('existing-wallets')?.addEventListener('change', () => resetSignatureState());

// ----------------------------
// PIN MODAL (Sign Transaction)
// ----------------------------
const signPinModal = document.getElementById('cw2SignPinModal');
const signPinLabel = document.getElementById('cw2SignPinLabel');
const signPinInput = document.getElementById('cw2-sign-pin-input');
const btnSubmitSignPin = document.getElementById('btn-submit-sign-pin');
const btnCancelSignPin = document.getElementById('btn-cancel-sign-pin');
const btnCloseSignPin = document.getElementById('btn-close-sign-pin');
let pendingSignPinResolve = null;

function openSignPin(deviceName) {
  if (!signPinModal) return Promise.resolve(null);
  if (signPinLabel) signPinLabel.textContent = `PIN for ${deviceName}`;
  if (signPinInput) signPinInput.value = '';
  signPinModal.classList.remove('hidden');
  setTimeout(() => signPinInput?.focus(), 0);
  return new Promise((resolve) => { pendingSignPinResolve = resolve; });
}

function closeSignPin(val = null) {
  if (!signPinModal) return;
  signPinModal.classList.add('hidden');
  const r = pendingSignPinResolve;
  pendingSignPinResolve = null;
  if (r) r(val);
}

btnSubmitSignPin?.addEventListener('click', () => {
  const v = (signPinInput?.value || '').trim();
  if (!v) return;
  closeSignPin(v);
});
btnCancelSignPin?.addEventListener('click', () => closeSignPin(null));
btnCloseSignPin?.addEventListener('click', () => closeSignPin(null));
signPinModal?.addEventListener('click', (e) => { if (e.target === signPinModal) closeSignPin(null); });
signPinInput?.addEventListener('keydown', (e) => { if (e.key === 'Enter') btnSubmitSignPin?.click(); });

function extractMessageToSign(messagesToSign) {
  if (!Array.isArray(messagesToSign) || messagesToSign.length === 0) return null;
  const msgItem = messagesToSign[0];
  return (msgItem && (msgItem.Data || msgItem.data || msgItem.HashedMessage || msgItem.hashedMessage || msgItem.message || msgItem.Message)) || null;
}

// ----------------------------
// SIGN BUTTON LOGIC
// ----------------------------
if (btnSignTx) {
  btnSignTx.addEventListener('click', async () => {
    if (!messageToSign) {
      setMainPrompt("⚠️ Error: No message to sign. Please Scan QR first.");
      return;
    }
    if (!currentSessionId) {
      setMainPrompt("⚠️ Error: Session ID missing. Please rescan QR.");
      return;
    }
    if (currentSignatures.size >= 2) {
      setMainPrompt("✅ Transaction already fully signed!");
      return;
    }

    const keyId = signerSelect?.value;
    if (!keyId) {
      setMainPrompt("⚠️ Please select a signer device.");
      return;
    }
    const signerText = signerSelect?.selectedOptions?.[0]?.textContent || 'Selected device';

    if (currentSignatures.has(keyId)) {
      setMainPrompt(`⚠️ ${signerText} has already signed! Select another device.`);
      return;
    }

    setMainPrompt(`Insert the PIN for ${signerText}`);
    const pin = await openSignPin(signerText);
    if (!pin) {
      setMainPrompt("Operation cancelled (No PIN entered).");
      return;
    }

    const encryptedPin = encryptUsingAES(pin);

    const originalText = btnSignTx.textContent;
    btnSignTx.disabled = true;
    btnSignTx.textContent = 'Signing...';
    setMainPrompt(`⏳ Tap or insert your ${signerText} to sign.`);

    try {
      const signSessionPayload = {
        sessionID: currentSessionId,
        partyMemberID: keyId,
        pin: encryptedPin
      };

      const signRes = await fetch('http://localhost:44379/api/Signature/sign', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(signSessionPayload)
      });
      if (!signRes.ok) {
        const errData = await signRes.json().catch(() => ({}));
        throw new Error(errData.message || `API Error ${signRes.status}`);
      }

      const signData = await signRes.json();
      currentSignatures.add(keyId);
      const count = currentSignatures.size;

      if (count < 2) {
        setMainPrompt(`✅ Signed with ${signerText}. One more signature needed.`);
        btnSignTx.textContent = `Sign (${count}/2)`;
        btnSignTx.disabled = false;
      } else {
        const signature = signData.resultObject;
        const currentAsset = (wallet.crypto || 'BTC').toString().toUpperCase();

        const signedPayload = JSON.stringify({
          action: "sign",
          rawTransaction: rawTransaction,
          signedInput: signature,
          crypto: currentAsset
        });

        renderQR(signedPayload, "Signature Generated");
        btnSignTx.textContent = "Show Result QR";
        btnSignTx.classList.remove('btn-success');
        btnSignTx.classList.add('btn-primary');
        btnSignTx.disabled = false;

        setMainPrompt("🎉 Threshold reached! Transaction fully signed.");
        btnSignTx.onclick = () => renderQR(signedPayload, "Signature Generated");
      }
    } catch (err) {
      console.error(err);
      setMainPrompt(`❌ Signing failed: ${err.message || err}`);
      btnSignTx.disabled = false;
      btnSignTx.textContent = originalText || 'Sign (0/2)';
    }
  });
}

// ----------------------------
// SCAN HANDLER (reuses camera modal)
// ----------------------------
async function cw2_handleDecodedText(decodedText, targetInputId) {
  const raw = (decodedText || "").trim();

  // Recipient Address scan
  if (targetInputId === 'recipient-address') {
    let cleanAddr = raw;
    const lower = cleanAddr.toLowerCase();
    if (lower.startsWith('ethereum:') || lower.startsWith('bitcoin:')) {
      cleanAddr = cleanAddr.split(':')[1] || cleanAddr;
    }
    if (cleanAddr.includes('?')) cleanAddr = cleanAddr.split('?')[0];

    const recipient = document.getElementById('recipient-address');
    if (recipient) {
      recipient.value = cleanAddr;
      recipient.dispatchEvent(new Event('input', { bubbles: true }));
    }
    setMainPrompt("Address loaded from QR.");
    cw2_closeScanner();
    return;
  }

  // Transaction-to-sign scan
  if (targetInputId === 'tx-hash-display') {
    try {
      const data = JSON.parse(raw);

      if (!wallet.partyId) {
        setMainPrompt("⚠️ Please select an existing wallet first (party missing).");
        cw2_closeScanner();
        return;
      }

      if (!data || !data.rawTxBytes || !Array.isArray(data.messagesToSign)) {
        setMainPrompt("⚠️ Unrecognized Transaction QR format.");
        cw2_closeScanner();
        return;
      }

      resetSignatureState({ clearHash: false });

      rawTransaction = data.rawTxBytes;
      messageToSign = extractMessageToSign(data.messagesToSign);

      if (txHashDisplay) txHashDisplay.value = messageToSign || '';

      // Like coldwallet(2): as soon as the TX QR is recognized, make the button available.
      if (btnSignTx) {
        btnSignTx.disabled = false;
        btnSignTx.textContent = 'Sign (0/2)';
        btnSignTx.classList.remove('btn-primary');
        btnSignTx.classList.add('btn-success');
        btnSignTx.onclick = null;
      }

      setMainPrompt("⏳ Initializing Signing Session...");

      const createPayload = { partyGUID: wallet.partyId, messageToSign: messageToSign };
      const createRes = await fetch('http://localhost:44379/api/Signature/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(createPayload)
      });
      if (!createRes.ok) throw new Error(`Failed to init session (${createRes.status})`);
      const createData = await createRes.json();
      currentSessionId = createData.resultObject;

      setMainPrompt("Session Ready. Select a device and click 'Sign' (2 required).");
      if (btnSignTx) {
        btnSignTx.disabled = false;
        btnSignTx.textContent = 'Sign (0/2)';
      }
    } catch (e) {
      console.warn(e);
      setMainPrompt("⚠️ Unrecognized QR (Text/JSON).");
    } finally {
      cw2_closeScanner();
    }
    return;
  }

  // Default fallback: fill input
  const target = document.getElementById(targetInputId);
  if (target) {
    target.value = raw;
    target.dispatchEvent(new Event('input', { bubbles: true }));
  }
  cw2_closeScanner();
}

/* QR SCANNER (camera) for "Transaction Creation" and "Sign Transaction"
   Uses html5-qrcode already included in this page.
   ----------------------------------------------------------- */

const scanModal = document.getElementById('scanQRModal');
const btnCloseScan = document.getElementById('btn-close-scan');
const btnScanRecipient = document.getElementById('btn-scan-recipient');
const btnScanTxHash = document.getElementById('btn-scan-qr');

let cw2QrScanner = null;
let cw2ScanTargetInput = null;

function cw2_openScanner(targetInputId) {
  cw2ScanTargetInput = document.getElementById(targetInputId);
  if (!scanModal || !cw2ScanTargetInput) return;

  scanModal.classList.remove('hidden');

  // Lazily create scanner instance
  if (!cw2QrScanner) {
    cw2QrScanner = new window.Html5Qrcode("qr-reader");
  }

  const config = { fps: 10, qrbox: 250 };

  // Start camera
  cw2QrScanner.start(
    { facingMode: "environment" },
    config,
    async (decodedText) => {
      // Close the modal right away once we have a decode (like coldwallet(2))
      // to avoid multiple reads / a lingering popup.
      cw2_closeScanner();
      try {
        if (typeof window.cw2_handleDecodedText === 'function') {
          await window.cw2_handleDecodedText(decodedText, targetInputId);
        } else {
          const el = document.getElementById(targetInputId);
          if (el) {
            el.value = (decodedText || "").trim();
            el.dispatchEvent(new Event('input', { bubbles: true }));
          }
          cw2_closeScanner();
        }
      } catch (e) {
        console.error(e);
        cw2_closeScanner();
      }
    },
    () => {} // ignore per-frame decode errors
  ).catch((err) => {
    console.error("QR scan start error:", err);
    // keep modal open, but show a lightweight message
    const hint = scanModal.querySelector('.text-muted');
    if (hint) hint.textContent = "Unable to access camera. Check permissions / HTTPS.";
  });
}

function cw2_closeScanner() {
  if (!scanModal) return;

  // Hide immediately (UX), then stop the camera in the background.
  scanModal.classList.add('hidden');

  if (cw2QrScanner) {
    cw2QrScanner.stop()
      .then(() => cw2QrScanner.clear())
      .catch(() => {}); // ignore stop errors
  }
}

if (btnCloseScan) btnCloseScan.addEventListener('click', cw2_closeScanner);

// Open scanner for the two buttons
if (btnScanRecipient) btnScanRecipient.addEventListener('click', () => cw2_openScanner('recipient-address'));
if (btnScanTxHash) btnScanTxHash.addEventListener('click', () => cw2_openScanner('tx-hash-display'));

// Optional: click on backdrop closes (if you want)
scanModal?.addEventListener('click', (e) => {
  if (e.target === scanModal) cw2_closeScanner();
});


// Expose scanner handlers for legacy scripts (module scope is not global)
try{
  if (typeof cw2_handleDecodedText === 'function') window.cw2_handleDecodedText = cw2_handleDecodedText;
  if (typeof cw2_openScanner === 'function') window.cw2_openScanner = cw2_openScanner;
  if (typeof cw2_closeScanner === 'function') window.cw2_closeScanner = cw2_closeScanner;
}catch(e){}

</script>